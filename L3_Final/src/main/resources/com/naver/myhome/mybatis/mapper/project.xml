<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.naver.myhome.mybatis.mapper.ProjectMapper">

	<insert id="Insert" parameterType="com.naver.myhome.domain.Project">
	    <selectKey keyProperty="ID" resultType="int" order="BEFORE">
	        SELECT PROJECT_ID.NEXTVAL FROM DUAL
	    </selectKey>
	    	INSERT INTO PROJECT (ID, TITLE, SUBTITLE)
	    	VALUES (#{ID}, #{TITLE}, #{SUBTITLE})
	</insert>

    <select id="getAllProjectList" resultType="com.naver.myhome.domain.Project">
        SELECT PROJECT.*, ROUND((SYSDATE-UPDATED_AT)*24*60) AS CURRENTTIME, ( SELECT COUNT(*) FROM TEAM WHERE PROJECT_ID = PROJECT.ID ) AS TEAMCOUNT
        FROM PROJECT
        ORDER BY CREATED_AT DESC
    </select>
    
    <select id="getFavoritProjectList" resultType="com.naver.myhome.domain.Project">
        SELECT P.*, ROUND((SYSDATE-UPDATED_AT)*24*60) AS CURRENTTIME, ( SELECT COUNT(*) FROM TEAM WHERE PROJECT_ID = P.ID ) AS TEAMCOUNT
        FROM PROJECT P
        JOIN FAVORITES F ON P.ID = F.PROJECT_ID
        WHERE F.EMPLOYEE_ID = #{employeeId}
        ORDER BY CREATED_AT DESC
    </select>
    
    <select id="getPartProjectList" resultType="com.naver.myhome.domain.Project">
		SELECT p.*, ROUND((SYSDATE-UPDATED_AT)*24*60) AS CURRENTTIME, ( SELECT COUNT(*) FROM TEAM WHERE PROJECT_ID = P.ID ) AS TEAMCOUNT
		FROM PROJECT P
		JOIN TEAM T ON P.ID = T.PROJECT_ID
		WHERE T.EMPLOYEE_ID = #{employeeId}
		AND P.ID NOT IN (
		    SELECT F.PROJECT_ID
		    FROM FAVORITES F
		)
		ORDER BY CREATED_AT DESC
    </select>

    <select id="getDetail" parameterType="int" resultType="Project">
        SELECT *
        FROM PROJECT
        WHERE ID = #{id}
    </select>

    <update id="updateColor">
        UPDATE PROJECT
        SET COLOR = #{color}
        WHERE ID = #{id}
    </update>

    <select id="checkFavorite" resultType="integer">
        SELECT ID
        FROM FAVORITES
       	WHERE PROJECT_ID = #{projectId} AND EMPLOYEE_ID = #{employeeId}
    </select>

    <insert id="addFavorite">
        INSERT INTO FAVORITES (EMPLOYEE_ID, PROJECT_ID)
        VALUES (#{employeeId}, #{projectId})
    </insert>

    <delete id="removeFavorite">
        DELETE FROM FAVORITES
        WHERE EMPLOYEE_ID = #{employeeId} AND PROJECT_ID = #{projectId}
    </delete>
    
    <select id="getDoneCount" resultType="integer">
    SELECT COALESCE(
    	(SELECT COUNT(*)
		FROM ISSUE
		WHERE UPDATED_AT >= SYSDATE - INTERVAL '7' DAY AND STATUS = 'Done' AND PROJECT_ID = #{projectId}
		GROUP BY STATUS), 0) FROM dual
    </select>
    
    <select id="getUpdateCount" resultType="integer">
	    SELECT COUNT(*)
	    FROM ISSUE
	    WHERE UPDATED_AT >= SYSDATE - INTERVAL '7' DAY 
	    AND CREATED_AT != UPDATED_AT
	    AND PROJECT_ID = #{projectId}
    </select>
    
    <select id="getCreateCount" resultType="integer">
		SELECT COUNT(*)
	    FROM ISSUE
	    WHERE CREATED_AT >= SYSDATE - INTERVAL '7' DAY AND PROJECT_ID = #{projectId}
    </select>
    
    <select id="getCriticalCount" resultType="integer">
	SELECT COALESCE(
	    (SELECT COUNT(*)
	     FROM ISSUE
	     WHERE UPDATED_AT >= SYSDATE - INTERVAL '7' DAY AND PRIORITY = 'Critical' AND PROJECT_ID = #{projectId}
	     GROUP BY PRIORITY), 0) FROM dual
    </select>
    
    <select id="todoCount" resultType="integer">
		SELECT COUNT(*)
	    FROM ISSUE
	    WHERE STATUS = 'To Do' AND PROJECT_ID = #{projectId}
    </select>   
     
    <select id="progressCount" resultType="integer">
		SELECT COUNT(*)
	    FROM ISSUE
	    WHERE STATUS = 'In Progress' AND PROJECT_ID = #{projectId}
    </select>   
     
    <select id="allDoneCount" resultType="integer">
		SELECT COUNT(*)
	    FROM ISSUE
	    WHERE STATUS = 'Done' AND PROJECT_ID = #{projectId}
    </select>    
    
    <select id="resolveCount" resultType="integer">
		SELECT COUNT(*)
	    FROM ISSUE
	    WHERE STATUS = 'Resolve' AND PROJECT_ID = #{projectId}
    </select>    
    
    <select id="allCriticalCount" resultType="integer">
		SELECT COUNT(*)
	    FROM ISSUE
	    WHERE PRIORITY = 'Critical' AND PROJECT_ID = #{projectId}
    </select>   
     
    <select id="highCount" resultType="integer">
		SELECT COUNT(*)
	    FROM ISSUE
	    WHERE PRIORITY = 'High' AND PROJECT_ID = #{projectId}
    </select>   
     
    <select id="middleCount" resultType="integer">
		SELECT COUNT(*)
	    FROM ISSUE
	    WHERE PRIORITY = 'Middle' AND PROJECT_ID = #{projectId}
    </select>    
    
    <select id="lowCount" resultType="integer">
		SELECT COUNT(*)
	    FROM ISSUE
	    WHERE PRIORITY = 'Low' AND PROJECT_ID = #{projectId}
    </select>        

</mapper>